<html>
	<head>
		<style type='text/css'>
			div.center-column {
				margin-left : 10%;
				width       : 80%;
			}
			
			textarea.data {
				width       : 100%;
				height      : 40%;
				font-family : monospace;
			}

			input.format {
				width       : 100%;
			}
		</style>
		<script type='text/javascript'>
			(function() { 
			var ns = {};
			window.ns = ns;

			// Check to see if the document is complete
			ns.checkReady = function() {
				// If the document is loaded
				if(document.readyState == "complete") {
					// Remove the readystate timer
					window.clearInterval(ns.interval);
					// Find format input element
					ns.$format = document.querySelector("input.format");
					// Listen to format changes
					ns.$format.addEventListener("keyup", ns.format);
					// Find theInput
					ns.$input = document.querySelector("#theInput");
					// Listen to input changes
					ns.$input.addEventListener("keyup", ns.format);
					// Find theOutput
					ns.$output = document.querySelector("#theOutput");
					// Start off with a format
					ns.format();
				}
			};

			// Format the block of text
			ns.format = function() {
				var format = ns.$format.value;
				var components = format.split(/\s+/);
				var lines = ns.$input.value.replace(/\t/g, "        ").split("\n");
				var job = {
					lines: lines,
					offsets: []
				};

				// The column that we'll be aligning to
				var oldColumn = 0, column = 0;

				var regex = new RegExp("(" + components.join("|") + ")");

				while(true) {
					console.log("____WHILE____");
					// Go through all the lines
					for(var i=0, iMax=lines.length; i<iMax; ++i) {
						var line = lines[i];
						var offset = line.substr(oldColumn).search(regex);
						
						console.log(line.substr(oldColumn), offset);
						if(offset > -1) {
							// Move the column to this offset
							column = Math.max(column, offset + oldColumn);
						}
					}

					for(var i=0, iMax=lines.length; i<iMax; ++i) {
						var line = lines[i];
						var offset = line.substr(oldColumn).search(regex);
						
						if(offset > -1) {
							offset += oldColumn;
							line = 
								line.substr(0, offset)
								+ new Array(column+1-offset).join("_")
								+ line.substr(offset)
								;
							lines[i] = line;
						}
					}

					if(column + 1 == oldColumn) break;
					// Remember the previous column
					oldColumn = column + 1;
				}

				ns.$output.value = lines.join("\n");
			}

			// Add a ready state change listener
			ns.interval = window.setInterval(ns.checkReady, 100);
			})("aligner");
		</script>
	</head>
	<body>
		<div class='center-column'>
			<table style='width: 100%'>
				<tr>
					<td>
						Format: 
					</td>
					<td style='width: 100%'>
						<input type='text' class='format' value='; :' />
					</td>
				</tr>
			</table>
			<textarea class='data' id='theInput'>
switch(something) {
	case 1: doSomething(); break; // Do something
	case 2: doSomethingElse(); break; // Do something else
	case 33: doSomethingElse(); break; // Do something else

	default: 
		fail("Not a chance"); // Didn't expect this
		break;
}
			</textarea>
			<textarea class='data' id='theOutput'></textarea>
		</div>
	</body>
</html>
