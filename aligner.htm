<html>
	<head>
		<style type='text/css'>
			div.center-column {
				margin-left : 10%;
				width       : 80%;
			}
			
			textarea.data {
				width       : 100%;
				height      : 40%;
				font-family : monospace;
			}

			input.format {
				width       : 100%;
			}

			ul.options {
				display    : block ; 
				text-align : left  ; 
				margin: 0px;
				padding: 0px;
			}

			ul.options li {
				display: inline-block;
			}
		</style>
		<script type='text/javascript'>
			(function() { 
			// var 
			ns = {};
			window.ns = ns;

			// Check to see if the document is complete
			ns.checkReady = function() {
				// If the document is loaded
				if(document.readyState == "complete") {
					// Remove the readystate timer
					window.clearInterval(ns.interval);
					// Find format input element
					ns.$format = document.querySelector("input.format");
					// Listen to format changes
					ns.$format.addEventListener("keyup", ns.format);
					// Find theInput
					ns.$input = document.querySelector("#theInput");
					// Find padLeft
					ns.$padLeft = document.querySelector("input[name=padLeft]");
					// Find sort
					ns.$sort = document.querySelector("input[name=sort]");
					var items;

					// Listen to input changes
					(function() {
						for(var i=0; i<arguments.length; ++i) {
							arguments[i].addEventListener("keyup", ns.format);
							arguments[i].addEventListener("click", ns.format);
						}
					})(ns.$input, ns.$padLeft, ns.$sort);

					// Find theOutput
					ns.$output = document.querySelector("#theOutput");
					// Start off with a format
					ns.format();
				}
			};

			// Format the block of text
			ns.format = function() {
				var format = ns.$format.value;
				var components = format.split(/\s+/);
				var lines = ns.$input.value.split("\n");
				var job = {
					lines: lines,
					offsets: []
				};
				var condom = 0;
				var padLeft = ns.$padLeft.checked;
				var sort = ns.$sort.checked;

				// The column that we'll be aligning to
				var oldColumn = 0, column = 0;

				var regex = new RegExp("\\s*(" + components.join("|") + ")");

				while(true) {
					console.log("____WHILE____");
					// Go through all the lines
					for(var i=0, iMax=lines.length; i<iMax; ++i) {
						var line = lines[i];
						var offset = line.substr(oldColumn).search(regex);
						
						console.log(line.substr(oldColumn), offset);
						if(offset > -1) {
							// Move the column to this offset
							column = Math.max(column, offset + oldColumn);
						}
					}

					for(var i=0, iMax=lines.length; i<iMax; ++i) {
						var line = lines[i];
						var offset = line.substr(oldColumn).search(regex);
						
						if(offset > -1) {
							offset += oldColumn;
							
							line = 
								// Everything left of the column
								line.substr(0, offset)
								// Padding based on longest line
								+ new Array(column+1+(padLeft?1:0)-offset).join(" ")
								// Everything from the column onward
								+ line.substr(offset).replace(/^\s*/, "")
								;
							lines[i] = line;
						}
					}

					if(column + 1 == oldColumn) break;
					// Remember the previous column
					oldColumn = column + 1 + (padLeft ? 1 : 0);
					if(++condom > 100) break;
				}

				if(sort) lines.sort();

				ns.$output.value = lines.join("\n");
			}

			// Add a ready state change listener
			ns.interval = window.setInterval(ns.checkReady, 100);
			})("aligner");
		</script>
	</head>
	<body>
		<div class='center-column'>
			<table style='width: 100%'>
				<tr>
					<td>
						Format: 
					</td>
					<td style='width: 100%'>
						<input type='text' class='format' value='; :' />
					</td>
				</tr>
			</table>
			<ul class='options'>
				<li>
					Pad Left: 
					<input type='checkbox' name='padLeft' />
				</li>
				<li>
					Sort: 
					<input type='checkbox' name='sort' CHECKED />
				</li>
			</ul>
			<textarea class='data' id='theInput'>
switch(something) {
	case 1: doSomething(); break; // Do something
	case 2: doSomethingElse(); break ; // Do something else
	case 33: doSomethingElse(); break; // Do something else
			</textarea>
<!--
	default: 
		fail("Not a chance"); // Didn't expect this
		break;
}
-->
			<textarea class='data' id='theOutput'></textarea>
		</div>
	</body>
</html>
